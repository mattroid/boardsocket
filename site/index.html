<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>boardsocket</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.3/react.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.3/react-dom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <style>
      /* http://www.paulirish.com/2012/box-sizing-border-box-ftw/ */
      html {
        box-sizing: border-box;
      }
      *, *:before, *:after {
        box-sizing: inherit;
      }
      
      body {
        font-family: sans-serif;
        width: 100%;
        height: 100%;
        margin:0;
        padding:0;
      }

      .Board {
        width: 1000px;
        height: 1000px;
        overflow: hidden;
        transform-origin: top left;
      }

      .Piece {
        border: 1px solid #000;
        width: 100px;
        height: 100px;
        float: left;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;       
      }

      .Piece:nth-child(10n+1) {
        clear:left;
      }

      @keyframes glyph1-run {
          from { background-position-x: 0; }
          to { background-position-x: -1980px; }
      }

      .glyph1, .glyph2, .glyph3 {
        height: 294px;
        width: 165px;
        background-image: url(http://www.fabiobiondi.com/blog/wp-content/uploads/2012/08/runningGrant.png);
        background-position: 0 0;
        animation-name: glyph1-run;
        animation-duration: 0.4s;
        animation-iteration-count: infinite;
        animation-timing-function: steps(12);
        transform: scale3d(0.25,0.25,1);
        transform-origin: 25% 0;
      }

      .player1{
	background-color:red;
      }
      .player2{
	background-color:yellow;
      }
      .player3{
	background-color:blue;
      }

      .server-on {
        background: green;
      }

      .server-off {
        background: red;
      }

    </style>
  </head>
  <body>
    <div id="app"></div>
    <script type="text/babel">
      var socket = io.connect()

      class Piece extends React.Component {
        constructor(props){
          super(props)
        }

        render(){
          return (<div onClick={this.props.onClick} className='Piece'>
            <div className={`glyph glyph${this.props.value} player${this.props.value}`}></div>
          </div>)
        }
      }
      

      class Board extends React.Component {
        constructor(props){
          super(props)
          this.state = {
      board : props.board,
      playerNum: props.playerNum,
            connected: props.connected
          }
        }

        componentWillReceiveProps(nextProps){
          this.setState({playerNum: nextProps.playerNum, board: nextProps.board, connected: nextProps.connected})
        }

        onClick(x, y) {
	    return (e) => {
		    console.log('clicking for player' + playerNum);
		    socket.emit('click', x, y, playerNum)
		}
        }

        render (){
          return <div className={`Board server-${this.state.connected ? 'on' : 'off'}`}>
            {this.state.board.map((a,x) => {
              return a.map((v,y) => {
                return <Piece onClick={this.onClick(x, y).bind(this)} key={`${x}_${y}`} x={x} y={y} value={v}></Piece>
              })
            })}
          </div>
        }
      }

      var board = []
      var connected = false
      var playerNum = 0;

      socket.on('disconnect', () => {
        connected = false
      })

      socket.on('connect', () => {
        connected = true
        renderApp();
      })
      socket.on('set_player_num',(num)=>{
        playerNum = num
      })

      socket.on('board', (incoming_board, x, y) => {
        console.log('board', incoming_board, x, y)
        if (x === undefined && y === undefined){
          board = incoming_board
        }else{
          board[x][y] = incoming_board
        }
        renderApp();
      })

      function renderApp(){
        ReactDOM.render(<Board connected={connected} board={board} playerNum={playerNum}></Board>, document.getElementById('app') )
      }
    </script>
  </body>
</html>
